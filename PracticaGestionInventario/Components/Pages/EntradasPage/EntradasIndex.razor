@page "/Entrada/Index"
@inject EntradasService entradasService
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Entradas</PageTitle>

<div class="container mt-3">
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Entradas</h5>

            <a class="btn btn-primary bi bi-plus-lg"
               href="/entradas/upsert/0">
                Crear
            </a>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Desde</label>
                    <InputDate class="form-control" @bind-Value="Desde" />
                </div>

                <!-- HASTA -->
                <div class="col-md-3">
                    <label class="form-label fw-bold">Hasta</label>
                    <InputDate class="form-control" @bind-Value="Hasta" />
                </div>

                <div class="col-md-6"></div>

                <!-- FILTRAR POR -->
                <div class="col-md-3">
                    <label class="form-label fw-bold">Filtrar por</label>
                    <InputSelect class="form-select" @bind-Value="Filtro">
                        <option value="">Elige una opción</option>
                        <option value="@nameof(Entradas.EntradaId)">Id</option>
                        <option value="@nameof(Entradas.Concepto)">Concepto</option>
                        <option value="@nameof(Entradas.Total)">Total</option>
                    </InputSelect>
                </div>

                <!-- BUSCAR -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">Buscar</label>
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               placeholder="Buscar"
                               @bind="ValorFiltro" />

                        <button class="btn btn-outline-primary bi bi-search"
                                @onclick="Buscar">
                        </button>

                        <button class="btn btn-outline-secondary bi bi-arrow-clockwise"
                                @onclick="Restablecer">
                        </button>
                    </div>
                </div>
            </div>

            <!-- TABLA -->
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="border-bottom">
                        <tr>
                            <th>Id</th>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th class="text-end">Total</th>
                            <th class="text-center">Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!ListaEntradas.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-center">
                                    No hay entradas
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var entrada in ListaEntradas)
                            {
                                <tr>
                                    <td>@entrada.EntradaId</td>
                                    <td>@entrada.Fecha.ToString("dd/MM/yyyy")</td>
                                    <td>@entrada.Concepto</td>
                                    <td class="text-end">@entrada.Total.ToString("N2")</td>
                                    <td class="text-center">
                                        <a class="btn btn-outline-primary btn-sm bi bi-pencil"
                                           href="/entradas/upsert/@entrada.EntradaId">
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- TOTAL -->
            <div class="d-flex justify-content-end fw-bold mt-3">
                Total: RD$ @ListaEntradas.Sum(e => e.Total).ToString("N2")
            </div>
        </div>
    </div>
</div>

@code {
    public DateTime? Desde { get; set; }
    public DateTime? Hasta { get; set; }
    public string Filtro { get; set; } = string.Empty;
    public string ValorFiltro { get; set; } = string.Empty;

    public List<Entradas> ListaEntradas { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await Buscar();
    }

    public async Task Buscar()
    {
        var lista = await entradasService.Listar(e => true);

        if (Desde.HasValue && Hasta.HasValue)
        {
            lista = lista.Where(e =>
                e.Fecha.Date >= Desde.Value.Date &&
                e.Fecha.Date <= Hasta.Value.Date).ToList();
        }

        if (!string.IsNullOrWhiteSpace(ValorFiltro))
        {
            if (Filtro == nameof(Entradas.EntradaId)
                && int.TryParse(ValorFiltro, out int id))
                lista = lista.Where(e => e.EntradaId == id).ToList();

            else if (Filtro == nameof(Entradas.Concepto))
                lista = lista.Where(e =>
                    e.Concepto.Contains(ValorFiltro,
                        StringComparison.OrdinalIgnoreCase)).ToList();

            else if (Filtro == nameof(Entradas.Total)
                && double.TryParse(ValorFiltro, out double total))
                lista = lista.Where(e => e.Total == total).ToList();
        }

        ListaEntradas = lista;
    }

    public async Task Restablecer()
    {
        Desde = null;
        Hasta = null;
        Filtro = string.Empty;
        ValorFiltro = string.Empty;
        await Buscar();
    }
}


